<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/adminLayout.html}">

<div layout:fragment="content">
	<main class="content">
		<div class="container-fluid">
		    <h1 class="h3 mb-3">카테고리 관리</h1>
		
		    <!-- 필터 영역 -->
		    <div class="row mb-3">
		        <div class="col-md-4">
		            <input type="text" id="categoryFilter" class="form-control" placeholder="카테고리명 검색">
		        </div>
		        <div class="col-md-1">
		            <button id="searchBtn" class="btn btn-primary w-100">검색</button>
		        </div>
		        <div class="col-md-1">
		            <button id="resetBtn" class="btn btn-secondary w-100">초기화</button>
		        </div>
		    </div>
		
		    <!-- 등록 폼 -->
		    <div class="card mb-4">
		        <div class="card-body">
		            <div class="row g-2 align-items-center">
		                <div class="col-md-3">
		                    <input type="text" id="newCategory" class="form-control" placeholder="카테고리명 입력">
		                </div>
		                <div class="col-md-4">
		                    <input type="text" id="newScoreStandard" class="form-control" placeholder="점수 부여 기준 (예: 1-5)">
		                </div>
		                <div class="col-md-4">
		                    <input type="text" id="newStandardDescription" class="form-control" placeholder="기준 설명 입력">
		                </div>
		                <div class="col-md-1">
		                    <button id="addBtn" class="btn btn-success w-100">등록</button>
		                </div>
		            </div>
		        </div>
		    </div>
		
		    <!-- 카테고리 테이블 -->
		    <div class="card">
		        <div class="card-body">
		            <table class="table table-hover align-middle">
		                <thead>
		                    <tr>
		                        <th>카테고리명</th>
		                        <th>점수 기준</th>
		                        <th>기준 설명</th>
		                        <th>수정</th>
		                        <th>삭제</th>
		                    </tr>
		                </thead>
		                <tbody id="categoryTableBody">
		                    <!-- 서버 데이터 렌더링 영역 -->
		                </tbody>
		            </table>
		        </div>
		    </div>
		</div>
		
		<!-- 카테고리 수정 모달 -->
		<div id="editModal" class="modal">
		    <h5>카테고리 수정</h5>
		    <form id="editForm">
		        <input type="hidden" id="editCategoryId">
		
		        <div class="mb-3">
		            <label for="editCategory" class="form-label">카테고리명</label>
		            <input type="text" id="editCategory" class="form-control">
		        </div>
		
		        <div class="mb-3">
		            <label for="editScoreStandard" class="form-label">점수 기준</label>
		            <input type="text" id="editScoreStandard" class="form-control">
		        </div>
		
		        <div class="mb-3">
		            <label for="editStandardDescription" class="form-label">기준 설명</label>
		            <input type="text" id="editStandardDescription" class="form-control">
		        </div>
		
		        <div class="text-end">
		            <button type="submit" class="btn btn-success">저장</button>
		            <button type="button" id="closeEditModal" class="btn btn-secondary">취소</button>
		        </div>
		    </form>
		</div>
		
	</main>
</div>


<!-- 스크립트 -->
<div layout:fragment="script">
<script>

	$(document).ready(function() {
	
	    function loadCategories(keyword = "") {
	        $.get("/api/admin/categories", function(data) {
	            const tbody = $("#categoryTableBody");
	            tbody.empty();
	
	            const filtered = data.filter(c => c.category.includes(keyword));
	
	            if (filtered.length === 0) {
	                tbody.append("<tr><td colspan='5' class='text-center'>조회된 데이터가 없습니다.</td></tr>");
	            } else {
	                filtered.forEach(category => {
	                    tbody.append(`
	                        <tr>
	                            <td>${category.category}</td>
	                            <td>${category.scoreStandard}</td>
	                            <td>${category.standardDescription}</td>
	                            <td class="text-center">
	                                <button class="btn btn-sm btn-warning editBtn" data-id="${category.categoryId}">수정</button>
	                            </td>
	                            <td class="text-center">
	                                <button class="btn btn-sm btn-danger deleteBtn" data-id="${category.categoryId}">삭제</button>
	                            </td>
	                        </tr>
	                    `);
	                });
	            }
	        });
	    }
	
	    // 등록
	    $("#addBtn").click(function() {
	        const data = {
	            category: $("#newCategory").val(),
	            scoreStandard: $("#newScoreStandard").val(),
	            standardDescription: $("#newStandardDescription").val()
	        };
	
	        if (!data.category || !data.scoreStandard || !data.standardDescription) {
	            alert("모든 항목을 입력하세요.");
	            return;
	        }
	
	        $.ajax({
	            type: "POST",
	            url: "/api/admin/categories",
	            contentType: "application/json",
	            data: JSON.stringify(data),
	            success: function() {
	                alert("등록 완료");
	                $("#newCategory").val("");
	                $("#newScoreStandard").val("");
	                $("#newStandardDescription").val("");
	                loadCategories();
	            },
	            error: function() {
	                alert("등록 실패");
	            }
	        });
	    });
	
	    // 검색
	    $("#searchBtn").click(function() {
	        const keyword = $("#categoryFilter").val();
	        loadCategories(keyword);
	    });
	
	    // 초기화
	    $("#resetBtn").click(function() {
	        $("#categoryFilter").val("");
	        loadCategories();
	    });
	
	    // 수정 버튼 클릭
		$(document).on("click", ".editBtn", function() {
		    const id = $(this).data("id");
		
		    $.get(`/api/admin/categories/${id}`, function(category) {
		        $("#editCategoryId").val(category.categoryId);
		        $("#editCategory").val(category.category);
		        $("#editScoreStandard").val(category.scoreStandard);
		        $("#editStandardDescription").val(category.standardDescription);
		
		        // 모달 열기 (users.html과 동일)
		        $("#editModal").show();
		    });
		});
	
	    // 모달 닫기
	    $("#cancelEditModal, #closeEditModal").click(function() {
	        $("#editModal").hide();
	    });
	
	    // 수정 저장
	    $("#editForm").submit(function(e) {
	        e.preventDefault();
	
	        const id = $("#editCategoryId").val();
	        const data = {
	            category: $("#editCategory").val(),
	            scoreStandard: $("#editScoreStandard").val(),
	            standardDescription: $("#editStandardDescription").val()
	        };
	
	        $.ajax({
	            type: "PUT",
	            url: `/api/admin/categories/${id}`,
	            contentType: "application/json",
	            data: JSON.stringify(data),
	            success: function() {
	                alert("수정 완료");
	                $("#editModal").hide();
	                loadCategories();
	            },
	            error: function() {
	                alert("수정 실패");
	            }
	        });
	    });
	
	    // 삭제
	    $(document).on("click", ".deleteBtn", function() {
	        const id = $(this).data("id");
	
	        if (confirm("정말 삭제하시겠습니까?")) {
	            $.ajax({
	                type: "DELETE",
	                url: `/api/admin/categories/${id}`,
	                success: function() {
	                    alert("삭제 완료");
	                    loadCategories();
	                },
	                error: function() {
	                    alert("삭제 실패");
	                }
	            });
	        }
	    });
	
	    // 초기 로딩
	    loadCategories();
	
	});
	
</script>
</div>

</html>
