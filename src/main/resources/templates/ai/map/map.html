<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>ì• ë‹ˆíŒ… | ì£¼ë³€ í«ìƒµ ì§€ë„</title>

  <link rel="icon" type="image/png" href="/soft_assets/img/favicon.png">
  <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,800" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-svg.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link id="pagestyle" href="../soft_assets/css/soft-ui-dashboard.css?v=1.1.0" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/js/logout.js"></script>

  <style>
    #map {
      width: 100%;
      height: 100%;
      border-radius: 10px;
    }

    .card-body {
      height: 650px;
      position: relative;
    }

    #searchHereBtn,
    #locateMeBtn {
      position: absolute;
      z-index: 10;
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      color: white;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: none;
      cursor: pointer;
    }

    #searchHereBtn {
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4A90E2;
    }

    #locateMeBtn {
      bottom: 20px;
      right: 20px;
      background-color: #00B894;
    }
  </style>

  <script type="text/javascript" th:src="|//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoMapKey}&libraries=clusterer|"></script>
</head>

<body class="g-sidenav-show bg-gray-100 virtual-reality">
  <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur">
    <div class="container-fluid py-2 px-3 d-flex justify-content-between align-items-center">
      <a href="/recommend/chat" class="d-flex align-items-center text-decoration-none">
        <div style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; margin-right: 12px;">
          <img src="/soft_assets/img/logo.png" alt="ë¡œê³ " style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        <div class="d-flex flex-column justify-content-center">
          <span class="text-muted small mb-0">Aniting</span>
          <span class="fw-bold fs-6">ë°˜ë ¤ë™ë¬¼ ì¶”ì²œ AI</span>
        </div>
      </a>
      <div class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav d-flex flex-row">
          <li class="nav-item me-3"><a href="/user/mypage" class="nav-link text-body font-weight-bold"><i class="fa fa-user me-1"></i> ë§ˆì´í˜ì´ì§€</a></li>
          <a href="javascript:void(0);" id="logoutBtn" class="nav-link text-body font-weight-bold">
            <i class="fa fa-sign-out-alt me-1"></i> ë¡œê·¸ì•„ì›ƒ
          </a>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ì§€ë„ -->
  <div class="border-radius-xl mt-3 mx-3 position-relative" style="background-image: url('../soft_assets/img/vr-bg.jpg'); background-size: cover;">
    <main class="main-content mt-1 border-radius-lg">
      <section class="py-5">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-lg-10">
              <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-info text-white text-center py-4">
                  <h4 id="selected-animal-title" class="mb-0"></h4>
                  <p class="mb-0 text-sm mt-2">ì„ íƒí•œ ë°˜ë ¤ë™ë¬¼ì— ëŒ€í•œ í«ìƒµì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.</p>
                </div>
                <div class="card-body bg-white">
                  <button id="searchHereBtn">ğŸ“ í˜„ ì§€ë„ì—ì„œ ê²€ìƒ‰</button>
                  <button id="locateMeBtn">ë‚´ ìœ„ì¹˜ë¡œ ì´ë™</button>
                  <div id="map">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                </div>
                <div class="text-center my-4">
                  <a href="/recommend/result" class="btn bg-gradient-info text-white px-5 py-2 rounded-pill">
                    <i class="fas fa-chevron-left me-2"></i>ì¶”ì²œ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
	  let map, userLoc;
	  let markers = [];
	  let shownPlaces = new Set();
	  let activeInfoWindow = null;
	
	  const selectedAnimal = localStorage.getItem("selectedAnimal") || "ë°˜ë ¤ë™ë¬¼";
	  document.getElementById("selected-animal-title").innerText = `"${selectedAnimal}" ê´€ë ¨ í«ìƒµ ì°¾ê¸°`;
	
	  const keywords = [
	    selectedAnimal + " ë¶„ì–‘",
	    selectedAnimal + " ìƒµ",
	    selectedAnimal + " ì…ì–‘",
	    selectedAnimal + " í«ìƒµ",
	    selectedAnimal + " ë™ë¬¼ ë³‘ì›"
	  ];
	
	  // í˜ì´ì§€ ë¡œë“œ í›„ ì§€ë„ ì´ˆê¸°í™”
	  window.onload = function () {
	    if (!window.kakao || !kakao.maps) {
	      alert("ì¹´ì¹´ì˜¤ë§µ SDKê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
	      return;
	    }
	
	    if (!navigator.geolocation) {
	      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
	      return;
	    }
	
	    navigator.geolocation.getCurrentPosition(function (position) {
	      const lat = position.coords.latitude;
	      const lng = position.coords.longitude;
	      userLoc = new kakao.maps.LatLng(lat, lng);
	
	      map = new kakao.maps.Map(document.getElementById("map"), {
	        center: userLoc,
	        level: 4
	      });
	
	      new kakao.maps.Circle({
	        center: userLoc,
	        radius: 100,
	        strokeWeight: 2,
	        strokeColor: '#4A90E2',
	        strokeOpacity: 0.8,
	        fillColor: '#4A90E2',
	        fillOpacity: 0.4,
	        map: map
	      });
	
	      const mapTypeControl = new kakao.maps.MapTypeControl();
	      map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
	
	      const zoomControl = new kakao.maps.ZoomControl();
	      map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
	
	      kakao.maps.event.addListener(map, 'idle', () => {
	        $('#searchHereBtn').fadeIn();
	        $('#locateMeBtn').fadeIn();
	      });
	
	      $('#searchHereBtn').on('click', () => {
	        searchInBounds(map.getBounds());
	      });
	
	      $('#locateMeBtn').on('click', () => {
	        map.panTo(userLoc);
	        $('#searchHereBtn').fadeOut();
	        $('#locateMeBtn').fadeOut();
	      });
	
	      searchInBounds(map.getBounds());
	    });
	  };
	
	  function searchInBounds(bounds) {
	    const ps = new kakao.maps.services.Places();
	    shownPlaces.clear();
	    markers.forEach(m => m.setMap(null));
	    markers = [];
	
	    keywords.forEach(keyword => {
	      ps.keywordSearch(keyword, (data, status) => {
	        if (status !== kakao.maps.services.Status.OK) return;
	
	        data.forEach(place => {
	          const pos = new kakao.maps.LatLng(place.y, place.x);
	          const key = place.id;
	
	          if (!bounds.contain(pos) || shownPlaces.has(key)) return;
	          shownPlaces.add(key);
	
	          const marker = new kakao.maps.Marker({ map, position: pos });
	          markers.push(marker);
	
	          const info = new kakao.maps.InfoWindow({
	            content: `
	              <div style="width: 250px; word-break: break-word; padding: 10px; font-size: 13px;">
	                <strong style="font-size: 14px;">${place.place_name}</strong><br/>
	                <span style="color: gray;">${place.category_name}</span><br/>
	                ${place.road_address_name || place.address_name}<br/>
	                <span style="color: gray;">Tel: ${place.phone || 'ì •ë³´ ì—†ìŒ'}</span><br/>
	                <a href="${place.place_url}" target="_blank" style="display:block; margin-top: 6px; color: #3366cc;">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>
	              </div>`
	          });
	
	          kakao.maps.event.addListener(marker, 'click', function () {
	            if (activeInfoWindow) activeInfoWindow.close();
	            info.open(map, marker);
	            activeInfoWindow = info;
	          });
	        });
	      }, { bounds });
	    });
	  }
	</script>

  <script src="../soft_assets/js/core/popper.min.js"></script>
  <script src="../soft_assets/js/core/bootstrap.min.js"></script>
</body>
</html>
